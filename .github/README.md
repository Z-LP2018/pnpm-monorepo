# ğŸš€ CI/CD é›†æˆæŒ‡å—

> æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†å¦‚ä½•ä¸º Gu Lu Gu Lu é¡¹ç›®ä»é›¶å¼€å§‹é›†æˆå®Œæ•´çš„ CI/CD æµç¨‹

[![GitHub Actions](https://img.shields.io/badge/CI/CD-GitHub%20Actions-blue)](https://docs.github.com/en/actions)
[![Docker](https://img.shields.io/badge/å®¹å™¨åŒ–-Docker-blue)](https://www.docker.com/)
[![Turborepo](https://img.shields.io/badge/æ„å»º-Turborepo-blue)](https://turbo.build/)

---

## ğŸ“‹ ç›®å½•

- [CI/CD æŠ€æœ¯é€‰å‹](#cicd-æŠ€æœ¯é€‰å‹)
- [é›†æˆæ­¥éª¤æ¦‚è§ˆ](#é›†æˆæ­¥éª¤æ¦‚è§ˆ)
- [è¯¦ç»†å®æ–½æ­¥éª¤](#è¯¦ç»†å®æ–½æ­¥éª¤)
- [ç¯å¢ƒé…ç½®](#ç¯å¢ƒé…ç½®)
- [éƒ¨ç½²ç­–ç•¥](#éƒ¨ç½²ç­–ç•¥)
- [ç›‘æ§ä¸å›æ»š](#ç›‘æ§ä¸å›æ»š)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## CI/CD æŠ€æœ¯é€‰å‹

ä»¥ä¸‹æŠ€æœ¯å°†åœ¨æ•´ä¸ª CI/CD æµç¨‹ä¸­ä½¿ç”¨ï¼š

| åŠŸèƒ½åˆ†ç±» | åŠŸèƒ½æ¨¡å—   | å®ç°æ–¹æ¡ˆ                    | å¯é€‰æ–¹æ¡ˆ                  | å¤‡æ³¨                    |
| -------- | ---------- | --------------------------- | ------------------------- | ----------------------- |
| æŒç»­é›†æˆ | CI å¹³å°    | GitHub Actions              | GitLab CI / Jenkins       | ä¸ GitHub æ·±åº¦é›†æˆ      |
| æŒç»­é›†æˆ | ä»£ç æ£€æŸ¥   | Oxlint + Prettier           | ESLint                    | å¿«é€Ÿæ£€æŸ¥ï¼Œæ€§èƒ½ä¼˜å¼‚      |
| æŒç»­é›†æˆ | ç±»å‹æ£€æŸ¥   | TypeScript Compiler         | -                         | ç±»å‹å®‰å…¨ä¿è¯            |
| æŒç»­é›†æˆ | å•å…ƒæµ‹è¯•   | Vitest                      | Jest                      | å¿«é€Ÿæµ‹è¯•ï¼ŒVite ç”Ÿæ€     |
| æŒç»­é›†æˆ | E2E æµ‹è¯•   | Playwright                  | Cypress                   | è·¨æµè§ˆå™¨æ”¯æŒ            |
| æŒç»­é›†æˆ | æµ‹è¯•è¦†ç›–ç‡ | Vitest Coverage             | Codecov                   | è¦†ç›–ç‡æŠ¥å‘Š              |
| æŒç»­é›†æˆ | æ„å»ºå·¥å…·   | Turborepo                   | Nx                        | Monorepo æ„å»ºä¼˜åŒ–       |
| æŒç»­é›†æˆ | æ„å»ºç¼“å­˜   | Turborepo Remote Cache      | GitHub Actions Cache      | åŠ é€Ÿæ„å»º                |
| æŒç»­éƒ¨ç½² | å®¹å™¨åŒ–     | Docker                      | Podman                    | æ ‡å‡†åŒ–éƒ¨ç½²              |
| æŒç»­éƒ¨ç½² | é•œåƒæ„å»º   | Docker Buildx               | Kaniko                    | å¤šå¹³å°æ„å»ºæ”¯æŒ          |
| æŒç»­éƒ¨ç½² | é•œåƒä»“åº“   | GitHub Container Registry   | Docker Hub / ç§æœ‰ä»“åº“     | ä¸ GitHub é›†æˆ          |
| æŒç»­éƒ¨ç½² | éƒ¨ç½²å¹³å°   | è‡ªå»ºæœåŠ¡å™¨ + Docker Compose | Kubernetes / Docker Swarm | åˆæœŸç®€å•ï¼ŒåæœŸå¯å‡çº§    |
| æŒç»­éƒ¨ç½² | Web æœåŠ¡å™¨ | Nginx                       | Caddy / Traefik           | åå‘ä»£ç† + é™æ€æ–‡ä»¶æœåŠ¡ |
| æŒç»­éƒ¨ç½² | è¿›ç¨‹ç®¡ç†   | Docker                      | PM2 / systemd             | å®¹å™¨åŒ–åç”± Docker ç®¡ç†  |
| ç‰ˆæœ¬ç®¡ç† | ç‰ˆæœ¬æ§åˆ¶   | Changesets                  | Semantic Release          | è‡ªåŠ¨åŒ–ç‰ˆæœ¬ç®¡ç†          |
| ç‰ˆæœ¬ç®¡ç† | å‘å¸ƒæµç¨‹   | GitHub Releases             | npm publish               | åŒ…å‘å¸ƒ                  |
| å®‰å…¨æ‰«æ | ä¾èµ–æ‰«æ   | GitHub Dependabot           | Snyk / WhiteSource        | è‡ªåŠ¨ä¾èµ–æ›´æ–°            |
| å®‰å…¨æ‰«æ | é•œåƒæ‰«æ   | Trivy                       | Clair / Snyk              | å®¹å™¨é•œåƒå®‰å…¨æ‰«æ        |
| ç›‘æ§å‘Šè­¦ | éƒ¨ç½²é€šçŸ¥   | GitHub Actions é€šçŸ¥         | Slack / é’‰é’‰ / é‚®ä»¶       | éƒ¨ç½²çŠ¶æ€é€šçŸ¥            |
| ç›‘æ§å‘Šè­¦ | å¥åº·æ£€æŸ¥   | è‡ªå®šä¹‰å¥åº·æ£€æŸ¥è„šæœ¬          | Kubernetes Liveness Probe | éƒ¨ç½²åéªŒè¯              |

---

## é›†æˆæ­¥éª¤æ¦‚è§ˆ

| é˜¶æ®µ   | æ­¥éª¤ | ä»»åŠ¡é¡¹                  | é¢„è®¡æ—¶é—´ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
| ------ | ---- | ----------------------- | -------- | ------ | ---- |
| é˜¶æ®µä¸€ | 1    | åˆ›å»ºæœåŠ¡ Dockerfile     | 1-2 å¤©   | P0     | â˜    |
| é˜¶æ®µä¸€ | 2    | åˆ›å»ºå‰ç«¯åº”ç”¨ Dockerfile | 1 å¤©     | P0     | â˜    |
| é˜¶æ®µä¸€ | 3    | é…ç½®ç¯å¢ƒå˜é‡ç®¡ç†        | 0.5 å¤©   | P0     | â˜    |
| é˜¶æ®µä¸€ | 4    | è®¾ç½® GitHub Secrets     | 0.5 å¤©   | P0     | â˜    |
| é˜¶æ®µäºŒ | 5    | åˆ›å»ºåŸºç¡€ CI å·¥ä½œæµ      | 1 å¤©     | P0     | â˜    |
| é˜¶æ®µäºŒ | 6    | æ·»åŠ ä»£ç æ£€æŸ¥ä¸æ ¼å¼åŒ–    | 0.5 å¤©   | P0     | â˜    |
| é˜¶æ®µäºŒ | 7    | æ·»åŠ ç±»å‹æ£€æŸ¥            | 0.5 å¤©   | P0     | â˜    |
| é˜¶æ®µäºŒ | 8    | æ·»åŠ å•å…ƒæµ‹è¯•            | 1 å¤©     | P1     | â˜    |
| é˜¶æ®µäºŒ | 9    | æ·»åŠ  E2E æµ‹è¯•           | 1-2 å¤©   | P1     | â˜    |
| é˜¶æ®µäºŒ | 10   | æ·»åŠ æ„å»ºéªŒè¯            | 0.5 å¤©   | P0     | â˜    |
| é˜¶æ®µä¸‰ | 11   | åˆ›å»º Docker æ„å»ºå·¥ä½œæµ  | 1 å¤©     | P0     | â˜    |
| é˜¶æ®µä¸‰ | 12   | åˆ›å»ºéƒ¨ç½²å·¥ä½œæµ          | 2 å¤©     | P0     | â˜    |
| é˜¶æ®µä¸‰ | 13   | é…ç½®å¤šç¯å¢ƒéƒ¨ç½²          | 1 å¤©     | P0     | â˜    |
| é˜¶æ®µä¸‰ | 14   | æ·»åŠ å¥åº·æ£€æŸ¥è„šæœ¬        | 0.5 å¤©   | P1     | â˜    |
| é˜¶æ®µä¸‰ | 15   | æ·»åŠ å›æ»šè„šæœ¬            | 0.5 å¤©   | P1     | â˜    |
| é˜¶æ®µä¸‰ | 16   | é…ç½® Nginx              | 1 å¤©     | P0     | â˜    |
| é˜¶æ®µå›› | 17   | é›†æˆç›‘æ§å‘Šè­¦            | 1 å¤©     | P1     | â˜    |
| é˜¶æ®µå›› | 18   | ä¼˜åŒ–æ„å»ºæ€§èƒ½            | 1 å¤©     | P1     | â˜    |
| é˜¶æ®µå›› | 19   | æ·»åŠ å®‰å…¨æ‰«æ            | 0.5 å¤©   | P1     | â˜    |
| é˜¶æ®µå›› | 20   | å®Œå–„æ–‡æ¡£                | 0.5 å¤©   | P2     | â˜    |

---

## è¯¦ç»†å®æ–½æ­¥éª¤

### é˜¶æ®µä¸€ï¼šåŸºç¡€è®¾æ–½å‡†å¤‡

#### æ­¥éª¤ 1: åˆ›å»ºæœåŠ¡ Dockerfile

ä¸ºæ¯ä¸ªå¾®æœåŠ¡åˆ›å»ºä¼˜åŒ–çš„ Dockerfileï¼Œä½¿ç”¨å¤šé˜¶æ®µæ„å»ºï¼š

| é…ç½®é¡¹   | è¯´æ˜                            | ç¤ºä¾‹å€¼                                |
| -------- | ------------------------------- | ------------------------------------- |
| ä½ç½®     | æœåŠ¡ç›®å½•ä¸‹çš„ Dockerfile         | `services/api-gateway/Dockerfile`     |
| æ„å»ºé˜¶æ®µ | Node.js 20 Alpine               | `node:20-alpine`                      |
| è¿è¡Œé˜¶æ®µ | Node.js 20 Alpineï¼ˆæœ€å°åŒ–é•œåƒï¼‰ | `node:20-alpine`                      |
| ä¾èµ–å®‰è£… | pnpm 9                          | `npm install -g pnpm@9`               |
| æ„å»ºå‘½ä»¤ | Turborepo è¿‡æ»¤æ„å»º              | `pnpm --filter @gulu/{service} build` |
| æš´éœ²ç«¯å£ | æœåŠ¡ç«¯å£                        | `3000`                                |

**éœ€è¦åˆ›å»º Dockerfile çš„æœåŠ¡**:

| æœåŠ¡åç§°        | Dockerfile è·¯å¾„                       | çŠ¶æ€ |
| --------------- | ------------------------------------- | ---- |
| API Gateway     | `services/api-gateway/Dockerfile`     | â˜    |
| File Service    | `services/file-service/Dockerfile`    | â˜    |
| Message Service | `services/message-service/Dockerfile` | â˜    |
| å…¶ä»–æœåŠ¡...     | `services/{service-name}/Dockerfile`  | â˜    |

**ç¤ºä¾‹æ¨¡æ¿** (Nest.js æœåŠ¡):

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:20-alpine AS builder

WORKDIR /app

# å¤åˆ¶ monorepo é…ç½®æ–‡ä»¶
COPY pnpm-workspace.yaml package.json pnpm-lock.yaml ./
COPY turbo.json ./

# å¤åˆ¶å…±äº«åŒ…
COPY packages ./packages

# å¤åˆ¶æœåŠ¡ä»£ç 
COPY services/api-gateway ./services/api-gateway

# å®‰è£… pnpm
RUN npm install -g pnpm@9

# å®‰è£…ä¾èµ–
RUN pnpm install --frozen-lockfile

# æ„å»º
RUN pnpm --filter @gulu/api-gateway build

# è¿è¡Œé˜¶æ®µ
FROM node:20-alpine AS runner

WORKDIR /app

# å®‰è£… pnpm
RUN npm install -g pnpm@9

# å¤åˆ¶æ„å»ºäº§ç‰©å’Œä¾èµ–
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/services/api-gateway/dist ./dist
COPY --from=builder /app/services/api-gateway/package.json ./package.json
COPY --from=builder /app/packages ./packages

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¯åŠ¨æœåŠ¡
CMD ["node", "dist/main.js"]
```

#### æ­¥éª¤ 2: åˆ›å»ºå‰ç«¯åº”ç”¨ Dockerfile

ä¸ºå‰ç«¯åº”ç”¨åˆ›å»º Dockerfileï¼ˆä½¿ç”¨ Nginx æä¾›é™æ€æ–‡ä»¶æœåŠ¡ï¼‰ï¼š

| é…ç½®é¡¹   | è¯´æ˜                    | ç¤ºä¾‹å€¼                          |
| -------- | ----------------------- | ------------------------------- |
| ä½ç½®     | åº”ç”¨ç›®å½•ä¸‹çš„ Dockerfile | `apps/gulu-test/Dockerfile`     |
| æ„å»ºé˜¶æ®µ | Node.js 20 Alpine       | `node:20-alpine`                |
| è¿è¡Œé˜¶æ®µ | Nginx Alpine            | `nginx:alpine`                  |
| æ„å»ºå‘½ä»¤ | Vite æ„å»º               | `pnpm --filter gulu-test build` |
| é™æ€æ–‡ä»¶ | å¤åˆ¶åˆ° Nginx ç›®å½•       | `/usr/share/nginx/html`         |
| æš´éœ²ç«¯å£ | HTTP ç«¯å£               | `80`                            |

**ç¤ºä¾‹æ¨¡æ¿** (Vue 3 åº”ç”¨):

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:20-alpine AS builder

WORKDIR /app

# å¤åˆ¶ monorepo é…ç½®æ–‡ä»¶
COPY pnpm-workspace.yaml package.json pnpm-lock.yaml ./
COPY turbo.json ./

# å¤åˆ¶å…±äº«åŒ…
COPY packages ./packages

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY apps/gulu-test ./apps/gulu-test

# å®‰è£… pnpm
RUN npm install -g pnpm@9

# å®‰è£…ä¾èµ–
RUN pnpm install --frozen-lockfile

# æ„å»º
RUN pnpm --filter gulu-test build

# è¿è¡Œé˜¶æ®µ
FROM nginx:alpine

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/apps/gulu-test/dist /usr/share/nginx/html

# å¤åˆ¶ Nginx é…ç½®ï¼ˆå¯é€‰ï¼‰
# COPY apps/gulu-test/nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

#### æ­¥éª¤ 3: é…ç½®ç¯å¢ƒå˜é‡ç®¡ç†

åˆ›å»ºç¯å¢ƒå˜é‡æ¨¡æ¿æ–‡ä»¶ï¼š

| æ–‡ä»¶è·¯å¾„                   | ç”¨é€”             | çŠ¶æ€ |
| -------------------------- | ---------------- | ---- |
| `.env.example`             | é€šç”¨ç¯å¢ƒå˜é‡æ¨¡æ¿ | â˜    |
| `.env.development.example` | å¼€å‘ç¯å¢ƒæ¨¡æ¿     | â˜    |
| `.env.production.example`  | ç”Ÿäº§ç¯å¢ƒæ¨¡æ¿     | â˜    |

**ç¯å¢ƒå˜é‡åˆ†ç±»**:

| åˆ†ç±»       | å˜é‡åç¤ºä¾‹                                                                            | è¯´æ˜            |
| ---------- | ------------------------------------------------------------------------------------- | --------------- |
| æ•°æ®åº“     | `POSTGRES_HOST`, `POSTGRES_PORT`, `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB` | PostgreSQL é…ç½® |
| ç¼“å­˜       | `REDIS_HOST`, `REDIS_PORT`, `REDIS_PASSWORD`                                          | Redis é…ç½®      |
| æ–‡æ¡£æ•°æ®åº“ | `MONGO_HOST`, `MONGO_PORT`, `MONGO_USER`, `MONGO_PASSWORD`, `MONGO_DB`                | MongoDB é…ç½®    |
| è®¤è¯       | `JWT_SECRET`, `JWT_EXPIRES_IN`                                                        | JWT é…ç½®        |
| æœåŠ¡ç«¯å£   | `API_GATEWAY_PORT`, `FILE_SERVICE_PORT`                                               | æœåŠ¡ç«¯å£é…ç½®    |
| å¤–éƒ¨æœåŠ¡   | `NACOS_SERVER`, `NACOS_NAMESPACE`                                                     | å¤–éƒ¨æœåŠ¡é…ç½®    |

#### æ­¥éª¤ 4: è®¾ç½® GitHub Secrets

åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ ä»¥ä¸‹ Secretsï¼š

| Secret åç§°              | ç”¨é€”                     | å¿…éœ€æ€§ | ç¯å¢ƒèŒƒå›´   |
| ------------------------ | ------------------------ | ------ | ---------- |
| `DOCKER_REGISTRY_TOKEN`  | Docker Registry è®¿é—®ä»¤ç‰Œ | å¿…éœ€   | æ‰€æœ‰ç¯å¢ƒ   |
| `NPM_TOKEN`              | NPM å‘å¸ƒä»¤ç‰Œ             | å¯é€‰   | æ‰€æœ‰ç¯å¢ƒ   |
| `CODECOV_TOKEN`          | Codecov ä»¤ç‰Œ             | å¯é€‰   | æ‰€æœ‰ç¯å¢ƒ   |
| `DEPLOY_SSH_KEY`         | éƒ¨ç½²æœåŠ¡å™¨ SSH ç§é’¥      | å¿…éœ€   | æ‰€æœ‰ç¯å¢ƒ   |
| `DEPLOY_HOST`            | éƒ¨ç½²æœåŠ¡å™¨åœ°å€           | å¿…éœ€   | æ‰€æœ‰ç¯å¢ƒ   |
| `DEPLOY_USER`            | éƒ¨ç½²æœåŠ¡å™¨ç”¨æˆ·å         | å¿…éœ€   | æ‰€æœ‰ç¯å¢ƒ   |
| `PROD_DB_PASSWORD`       | ç”Ÿäº§æ•°æ®åº“å¯†ç            | å¿…éœ€   | ç”Ÿäº§ç¯å¢ƒ   |
| `PROD_REDIS_PASSWORD`    | ç”Ÿäº§ Redis å¯†ç           | å¿…éœ€   | ç”Ÿäº§ç¯å¢ƒ   |
| `PROD_JWT_SECRET`        | ç”Ÿäº§ JWT å¯†é’¥            | å¿…éœ€   | ç”Ÿäº§ç¯å¢ƒ   |
| `STAGING_DB_PASSWORD`    | é¢„å‘å¸ƒç¯å¢ƒæ•°æ®åº“å¯†ç      | å¿…éœ€   | é¢„å‘å¸ƒç¯å¢ƒ |
| `STAGING_REDIS_PASSWORD` | é¢„å‘å¸ƒç¯å¢ƒ Redis å¯†ç     | å¿…éœ€   | é¢„å‘å¸ƒç¯å¢ƒ |

**è®¾ç½®è·¯å¾„**: `Settings > Secrets and variables > Actions`

---

### é˜¶æ®µäºŒï¼šCI æµç¨‹æ„å»º

#### æ­¥éª¤ 5: åˆ›å»ºåŸºç¡€ CI å·¥ä½œæµ

åˆ›å»º `.github/workflows/ci.yml` æ–‡ä»¶ï¼š

| é…ç½®é¡¹       | è¯´æ˜                | å€¼                         |
| ------------ | ------------------- | -------------------------- |
| è§¦å‘æ¡ä»¶     | Push / Pull Request | `main`, `dev` åˆ†æ”¯         |
| è¿è¡Œç¯å¢ƒ     | Ubuntu Latest       | `ubuntu-latest`            |
| Node.js ç‰ˆæœ¬ | 20.x                | `20.x`                     |
| pnpm ç‰ˆæœ¬    | 9                   | `9`                        |
| å¹¶å‘æ§åˆ¶     | å–æ¶ˆè¿›è¡Œä¸­çš„å·¥ä½œæµ  | `cancel-in-progress: true` |

**å·¥ä½œæµæ­¥éª¤**:

| æ­¥éª¤é¡ºåº | æ­¥éª¤åç§°      | å‘½ä»¤/å·¥å…·                        | è¯´æ˜            |
| -------- | ------------- | -------------------------------- | --------------- |
| 1        | Checkout ä»£ç  | `actions/checkout@v4`            | æ‹‰å–ä»£ç         |
| 2        | å®‰è£… pnpm     | `pnpm/action-setup@v4`           | è®¾ç½® pnpm       |
| 3        | è®¾ç½® Node.js  | `actions/setup-node@v4`          | è®¾ç½® Node.js    |
| 4        | å®‰è£…ä¾èµ–      | `pnpm install --frozen-lockfile` | å®‰è£…ä¾èµ–        |
| 5        | ä»£ç æ ¼å¼æ£€æŸ¥  | `pnpm format:check`              | Prettier æ£€æŸ¥   |
| 6        | ä»£ç è´¨é‡æ£€æŸ¥  | `pnpm lint`                      | Oxlint æ£€æŸ¥     |
| 7        | ç±»å‹æ£€æŸ¥      | `pnpm type-check`                | TypeScript æ£€æŸ¥ |
| 8        | è¿è¡Œæµ‹è¯•      | `pnpm test`                      | å•å…ƒæµ‹è¯•        |
| 9        | æ„å»ºé¡¹ç›®      | `pnpm build`                     | æ„å»ºéªŒè¯        |

#### æ­¥éª¤ 6-10: CI æµç¨‹å®Œå–„

| æ­¥éª¤ | ä»»åŠ¡é¡¹           | å®ç°æ–¹å¼            | é…ç½®æ–‡ä»¶ä½ç½®                    | çŠ¶æ€ |
| ---- | ---------------- | ------------------- | ------------------------------- | ---- |
| 6    | ä»£ç æ£€æŸ¥ä¸æ ¼å¼åŒ– | Oxlint + Prettier   | `.oxlintrc.json`, `.prettierrc` | â˜    |
| 7    | ç±»å‹æ£€æŸ¥         | TypeScript Compiler | `tsconfig.json`                 | â˜    |
| 8    | å•å…ƒæµ‹è¯•         | Vitest              | `vitest.config.ts`              | â˜    |
| 9    | E2E æµ‹è¯•         | Playwright          | `playwright.config.ts`          | â˜    |
| 10   | æ„å»ºéªŒè¯         | Turborepo           | `turbo.json`                    | â˜    |

---

### é˜¶æ®µä¸‰ï¼šCD æµç¨‹æ„å»º

#### æ­¥éª¤ 11: åˆ›å»º Docker æ„å»ºå·¥ä½œæµ

åˆ›å»º `.github/workflows/docker-build.yml` æ–‡ä»¶ï¼š

| é…ç½®é¡¹   | è¯´æ˜                      | å€¼                     |
| -------- | ------------------------- | ---------------------- |
| è§¦å‘æ¡ä»¶ | Push to main / Tags       | `main` åˆ†æ”¯, `v*` æ ‡ç­¾ |
| é•œåƒä»“åº“ | GitHub Container Registry | `ghcr.io`              |
| æ„å»ºå·¥å…· | Docker Buildx             | å¤šå¹³å°æ„å»ºæ”¯æŒ         |
| ç¼“å­˜ç­–ç•¥ | GitHub Actions Cache      | åŠ é€Ÿæ„å»º               |

**æ„å»ºçŸ©é˜µ**:

| æœåŠ¡/åº”ç”¨    | é•œåƒåç§°                      | Dockerfile è·¯å¾„                    | çŠ¶æ€ |
| ------------ | ----------------------------- | ---------------------------------- | ---- |
| API Gateway  | `ghcr.io/{repo}/api-gateway`  | `services/api-gateway/Dockerfile`  | â˜    |
| File Service | `ghcr.io/{repo}/file-service` | `services/file-service/Dockerfile` | â˜    |
| å‰ç«¯åº”ç”¨     | `ghcr.io/{repo}/gulu-test`    | `apps/gulu-test/Dockerfile`        | â˜    |

#### æ­¥éª¤ 12: åˆ›å»ºéƒ¨ç½²å·¥ä½œæµ

åˆ›å»º `.github/workflows/deploy.yml` æ–‡ä»¶ï¼š

| é…ç½®é¡¹   | è¯´æ˜                 | å€¼                            |
| -------- | -------------------- | ----------------------------- |
| è§¦å‘æ¡ä»¶ | Push / æ‰‹åŠ¨è§¦å‘      | `main`, `staging`, `dev` åˆ†æ”¯ |
| éƒ¨ç½²æ–¹å¼ | SSH + Docker Compose | è¿œç¨‹æœåŠ¡å™¨éƒ¨ç½²                |
| éƒ¨ç½²ç­–ç•¥ | è“ç»¿éƒ¨ç½² / æ»šåŠ¨æ›´æ–°  | æ ¹æ®ç¯å¢ƒé€‰æ‹©                  |

**ç¯å¢ƒæ˜ å°„**:

| åˆ†æ”¯      | ç¯å¢ƒ       | éƒ¨ç½²ç›®æ ‡     | Docker Compose æ–‡ä»¶          |
| --------- | ---------- | ------------ | ---------------------------- |
| `main`    | ç”Ÿäº§ç¯å¢ƒ   | ç”Ÿäº§æœåŠ¡å™¨   | `docker-compose.prod.yml`    |
| `staging` | é¢„å‘å¸ƒç¯å¢ƒ | é¢„å‘å¸ƒæœåŠ¡å™¨ | `docker-compose.staging.yml` |
| `dev`     | å¼€å‘ç¯å¢ƒ   | å¼€å‘æœåŠ¡å™¨   | `docker-compose.yml`         |

#### æ­¥éª¤ 13-16: CD æµç¨‹å®Œå–„

| æ­¥éª¤ | ä»»åŠ¡é¡¹       | å®ç°æ–¹å¼                  | é…ç½®æ–‡ä»¶ä½ç½®                   | çŠ¶æ€ |
| ---- | ------------ | ------------------------- | ------------------------------ | ---- |
| 13   | å¤šç¯å¢ƒéƒ¨ç½²   | ç¯å¢ƒå˜é‡ + Docker Compose | `.env.{env}` æ–‡ä»¶              | â˜    |
| 14   | å¥åº·æ£€æŸ¥è„šæœ¬ | è‡ªå®šä¹‰ Node.js è„šæœ¬       | `scripts/health-check.mjs`     | â˜    |
| 15   | å›æ»šè„šæœ¬     | è‡ªå®šä¹‰ Node.js è„šæœ¬       | `scripts/rollback.mjs`         | â˜    |
| 16   | Nginx é…ç½®   | Nginx é…ç½®æ–‡ä»¶            | `infrastructure/docker/nginx/` | â˜    |

---

### é˜¶æ®µå››ï¼šç›‘æ§ä¸ä¼˜åŒ–

| æ­¥éª¤ | ä»»åŠ¡é¡¹       | å®ç°æ–¹å¼                      | é…ç½®æ–‡ä»¶ä½ç½®                   | çŠ¶æ€ |
| ---- | ------------ | ----------------------------- | ------------------------------ | ---- |
| 17   | ç›‘æ§å‘Šè­¦     | GitHub Actions é€šçŸ¥ / Webhook | `.github/workflows/notify.yml` | â˜    |
| 18   | æ„å»ºæ€§èƒ½ä¼˜åŒ– | Turborepo è¿œç¨‹ç¼“å­˜            | `turbo.json`                   | â˜    |
| 19   | å®‰å…¨æ‰«æ     | Dependabot + Trivy            | `.github/dependabot.yml`       | â˜    |
| 20   | å®Œå–„æ–‡æ¡£     | Markdown æ–‡æ¡£                 | `docs/deployment.md`           | â˜    |

---

## ç¯å¢ƒé…ç½®

| ç¯å¢ƒ       | è§¦å‘æ¡ä»¶                        | éƒ¨ç½²ç›®æ ‡     | æ•°æ®åº“                           | ç‰¹æ€§                       |
| ---------- | ------------------------------- | ------------ | -------------------------------- | -------------------------- |
| å¼€å‘ç¯å¢ƒ   | æ¨é€åˆ° `dev` åˆ†æ”¯               | å¼€å‘æœåŠ¡å™¨   | å¼€å‘æ•°æ®åº“å®ä¾‹                   | è‡ªåŠ¨éƒ¨ç½²ã€å¿«é€Ÿè¿­ä»£         |
| é¢„å‘å¸ƒç¯å¢ƒ | æ¨é€åˆ° `staging` åˆ†æ”¯æˆ–æ‰‹åŠ¨è§¦å‘ | é¢„å‘å¸ƒæœåŠ¡å™¨ | é¢„å‘å¸ƒæ•°æ®åº“å®ä¾‹ï¼ˆç”Ÿäº§æ•°æ®å‰¯æœ¬ï¼‰ | å®Œæ•´æµ‹è¯•ã€æ€§èƒ½éªŒè¯         |
| ç”Ÿäº§ç¯å¢ƒ   | æ¨é€åˆ° `main` åˆ†æ”¯æˆ–æ‰‹åŠ¨è§¦å‘    | ç”Ÿäº§æœåŠ¡å™¨   | ç”Ÿäº§æ•°æ®åº“                       | è“ç»¿éƒ¨ç½²ã€é›¶åœæœºã€è‡ªåŠ¨å›æ»š |

---

## éƒ¨ç½²ç­–ç•¥

| ç­–ç•¥åç§°   | é€‚ç”¨åœºæ™¯         | å®ç°æ–¹å¼         | ä¼˜ç‚¹                 | ç¼ºç‚¹       |
| ---------- | ---------------- | ---------------- | -------------------- | ---------- |
| è“ç»¿éƒ¨ç½²   | ç”Ÿäº§ç¯å¢ƒé‡å¤§æ›´æ–° | åŒç¯å¢ƒåˆ‡æ¢       | é›¶åœæœºã€å¿«é€Ÿå›æ»š     | èµ„æºå ç”¨å¤š |
| æ»šåŠ¨æ›´æ–°   | å¾®æœåŠ¡å¸¸è§„æ›´æ–°   | é€ä¸ªæ›¿æ¢å®ä¾‹     | èµ„æºå ç”¨å°‘ã€å¹³æ»‘å‡çº§ | å›æ»šè¾ƒæ…¢   |
| é‡‘ä¸é›€å‘å¸ƒ | é‡å¤§åŠŸèƒ½éªŒè¯     | é€æ­¥æ‰©å¤§æµé‡èŒƒå›´ | é£é™©å¯æ§ã€æ¸è¿›å¼éªŒè¯ | éƒ¨ç½²å‘¨æœŸé•¿ |

---

## ç›‘æ§ä¸å›æ»š

### å¥åº·æ£€æŸ¥æŒ‡æ ‡

| æŒ‡æ ‡ç±»å‹   | æ£€æŸ¥é¡¹         | é˜ˆå€¼/æ ‡å‡† | æ£€æŸ¥æ–¹å¼     |
| ---------- | -------------- | --------- | ------------ |
| æœåŠ¡å¯ç”¨æ€§ | HTTP çŠ¶æ€ç     | 200       | HTTP è¯·æ±‚    |
| å“åº”æ—¶é—´   | P95 å“åº”æ—¶é—´   | < 500ms   | æ€§èƒ½ç›‘æ§     |
| é”™è¯¯ç‡     | é”™è¯¯è¯·æ±‚æ¯”ä¾‹   | < 0.1%    | æ—¥å¿—åˆ†æ     |
| æ•°æ®åº“è¿æ¥ | è¿æ¥çŠ¶æ€       | æ­£å¸¸      | å¥åº·æ£€æŸ¥æ¥å£ |
| ç¼“å­˜è¿æ¥   | Redis è¿æ¥çŠ¶æ€ | æ­£å¸¸      | å¥åº·æ£€æŸ¥æ¥å£ |

### è‡ªåŠ¨å›æ»šè§¦å‘æ¡ä»¶

| è§¦å‘æ¡ä»¶         | é˜ˆå€¼ | å›æ»šåŠ¨ä½œ           |
| ---------------- | ---- | ------------------ |
| å¥åº·æ£€æŸ¥è¿ç»­å¤±è´¥ | 3 æ¬¡ | è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬ |
| é”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼   | 5%   | è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬ |
| å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼ | 2s   | è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬ |
| æ•°æ®åº“è¿æ¥å¤±è´¥   | 1 æ¬¡ | è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬ |

### ç›‘æ§å·¥å…·é›†æˆ

| å·¥å…·ç±»å‹     | æ¨èæ–¹æ¡ˆ                | ç”¨é€”     |
| ------------ | ----------------------- | -------- |
| åº”ç”¨ç›‘æ§     | Sentry / Datadog        | é”™è¯¯è¿½è¸ª |
| åŸºç¡€è®¾æ–½ç›‘æ§ | Prometheus + Grafana    | æŒ‡æ ‡ç›‘æ§ |
| æ—¥å¿—èšåˆ     | ELK Stack / Loki        | æ—¥å¿—åˆ†æ |
| APM          | New Relic / AppDynamics | æ€§èƒ½ç›‘æ§ |

---

## å¸¸è§é—®é¢˜

| é—®é¢˜                   | è§£å†³æ–¹æ¡ˆ                                                             |
| ---------------------- | -------------------------------------------------------------------- |
| å¦‚ä½•åªéƒ¨ç½²ç‰¹å®šæœåŠ¡ï¼Ÿ   | ä½¿ç”¨å·¥ä½œæµè¾“å…¥å‚æ•°æˆ–ä¿®æ”¹æ–‡ä»¶è§¦å‘æ¡ä»¶ï¼Œæ”¯æŒé€‰æ‹©æœåŠ¡                   |
| å¦‚ä½•å¤„ç†æ•°æ®åº“è¿ç§»ï¼Ÿ   | åœ¨éƒ¨ç½²å‰è¿è¡Œè¿ç§»è„šæœ¬ï¼Œä½¿ç”¨ `scripts/db-migrate.mjs`                  |
| å¦‚ä½•å®ç°é›¶åœæœºéƒ¨ç½²ï¼Ÿ   | ä½¿ç”¨è“ç»¿éƒ¨ç½²æˆ–æ»šåŠ¨æ›´æ–°ç­–ç•¥ï¼Œæ–°å®ä¾‹å¥åº·æ£€æŸ¥é€šè¿‡åå†åˆ‡æ¢æµé‡           |
| å¦‚ä½•ä¼˜åŒ–æ„å»ºæ—¶é—´ï¼Ÿ     | ä½¿ç”¨ Turborepo è¿œç¨‹ç¼“å­˜ã€å¹¶è¡Œæ„å»ºã€Docker å±‚ç¼“å­˜ã€åªæ„å»ºå˜æ›´çš„æœåŠ¡   |
| å¦‚ä½•å¤„ç† Secretsï¼Ÿ     | ä½¿ç”¨ GitHub Secrets å­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼Œç¯å¢ƒå˜é‡æ³¨å…¥åˆ°å®¹å™¨ï¼Œä¸è¦ç¡¬ç¼–ç      |
| å¦‚ä½•è°ƒè¯•éƒ¨ç½²å¤±è´¥ï¼Ÿ     | æŸ¥çœ‹ GitHub Actions æ—¥å¿—ã€æ£€æŸ¥å¥åº·æ£€æŸ¥è„šæœ¬ã€éªŒè¯ç¯å¢ƒå˜é‡é…ç½®         |
| å¦‚ä½•å›æ»šéƒ¨ç½²ï¼Ÿ         | ä½¿ç”¨ `scripts/rollback.mjs` è„šæœ¬ï¼Œæˆ–æ‰‹åŠ¨åˆ‡æ¢åˆ°ä¸Šä¸€ç‰ˆæœ¬çš„ Docker é•œåƒ |
| å¦‚ä½•æ·»åŠ æ–°çš„éƒ¨ç½²ç¯å¢ƒï¼Ÿ | åˆ›å»ºæ–°çš„ç¯å¢ƒé…ç½®æ–‡ä»¶ã€æ·»åŠ å¯¹åº”çš„ GitHub Secretsã€æ›´æ–°éƒ¨ç½²å·¥ä½œæµ      |

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

| ä¼˜å…ˆçº§ | ä»»åŠ¡é¡¹                    | è´Ÿè´£äºº | é¢„è®¡å®Œæˆæ—¶é—´ | çŠ¶æ€ |
| ------ | ------------------------- | ------ | ------------ | ---- |
| P0     | åˆ›å»ºæ‰€æœ‰æœåŠ¡çš„ Dockerfile | -      | 1-2 å¤©       | â˜    |
| P0     | é…ç½® GitHub Secrets       | -      | 0.5 å¤©       | â˜    |
| P0     | åˆ›å»ºåŸºç¡€ CI å·¥ä½œæµ        | -      | 1 å¤©         | â˜    |
| P0     | åˆ›å»º Docker æ„å»ºå·¥ä½œæµ    | -      | 1 å¤©         | â˜    |
| P0     | åˆ›å»ºéƒ¨ç½²å·¥ä½œæµ            | -      | 2 å¤©         | â˜    |
| P1     | æ·»åŠ å¥åº·æ£€æŸ¥å’Œå›æ»šè„šæœ¬    | -      | 1 å¤©         | â˜    |
| P1     | è®¾ç½®ç›‘æ§å‘Šè­¦              | -      | 1 å¤©         | â˜    |
| P1     | ä¼˜åŒ–æ„å»ºæ€§èƒ½              | -      | 1 å¤©         | â˜    |
| P2     | å®Œå–„æ–‡æ¡£                  | -      | 0.5 å¤©       | â˜    |

---

## å‚è€ƒèµ„æº

| èµ„æºç±»å‹            | é“¾æ¥                                                                   | è¯´æ˜              |
| ------------------- | ---------------------------------------------------------------------- | ----------------- |
| GitHub Actions æ–‡æ¡£ | [GitHub Actions æ–‡æ¡£](https://docs.github.com/en/actions)              | å®˜æ–¹æ–‡æ¡£          |
| Docker æœ€ä½³å®è·µ     | [Docker æœ€ä½³å®è·µ](https://docs.docker.com/develop/dev-best-practices/) | Docker ä¼˜åŒ–æŒ‡å—   |
| Turborepo æ–‡æ¡£      | [Turborepo æ–‡æ¡£](https://turbo.build/repo/docs)                        | Monorepo æ„å»ºå·¥å…· |
| Nest.js éƒ¨ç½²æŒ‡å—    | [Nest.js éƒ¨ç½²æŒ‡å—](https://docs.nestjs.com/recipes/deployment)         | Nest.js æœåŠ¡éƒ¨ç½²  |

---

**æœ€åæ›´æ–°**: 2024-12-19  
**ç»´æŠ¤è€…**: DevOps å›¢é˜Ÿ
